{
    "sourceFile": "src/controller/userController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1658658485956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1658658485956,
            "name": "Commit-0",
            "content": "\r\nconst pool = require('../config/connectDatabase')\r\nconst md5 = require('md5')\r\nclass UserController {\r\n    // [GET] REGISTER\r\n    register = (req, res) => {\r\n        res.render('pages/register', { error: '' });\r\n    }\r\n    // [POST] REGISTER\r\n    registerPost = async (req, res) => {\r\n        const { name, password, sdt, address, sex, email } = req.body;\r\n        const hashPassword = md5(Number(password));\r\n        const sql = `INSERT INTO thanhvien (sdt, cmnd, address, name, id_thanhvien, email, mat_khau, quyen_truy_cap, gioi_tinh) VALUES ('${sdt}', ${sdt}, '${address}', '${name}', NULL, '${email}', '${hashPassword}', 0, ${sex ? sex : 2})`;\r\n        const result = await pool.execute(sql);\r\n        console.log(result);\r\n        if (result) {\r\n\r\n        }\r\n        res.redirect('/user/login');\r\n    }\r\n    // GET Login\r\n    login = (req, res) => {\r\n        if (req.signedCookies.email_user) {\r\n            res.redirect('/');\r\n        }\r\n        res.render('pages/login', { error: '' });\r\n    }\r\n\r\n    loginPost = async (req, res) => {\r\n        const { username, password } = req.body;\r\n        const hashPassword = md5(Number(password));\r\n        const sql = `SELECT * FROM thanhvien WHERE email = '${username}' AND mat_khau = '${hashPassword}'`;\r\n        const [rows] = await pool.execute(sql);\r\n        if (rows.length > 0 && rows[0].quyen_truy_cap === 0) {\r\n\r\n            res.cookie('email_user', rows[0].email, {\r\n                signed: true,\r\n            });\r\n            res.cookie('id_user', rows[0].id_thanhvien, {\r\n                signed: true,\r\n            });\r\n            res.redirect('/');\r\n            return;\r\n        }\r\n        else {\r\n            res.render('pages/login', { error: 'Sai tài khoản hoặc mật khẩu' });\r\n            return;\r\n        }\r\n    }\r\n\r\n\r\n    // GET Logout\r\n    logout = (req, res) => {\r\n        res.clearCookie('email_user');\r\n        res.clearCookie('id_user');\r\n        return res.redirect('/');\r\n    }\r\n\r\n    // GET Profile\r\n    profile = async (req, res) => {\r\n        const sql = `SELECT * FROM thanhvien WHERE email = '${req.signedCookies.email_user}'`;\r\n        const [rows] = await pool.execute(sql);\r\n        if (rows.length > 0) {\r\n            res.render('pages/index.ejs', {\r\n                user: rows[0],\r\n                page_layout: 'profile',\r\n            });\r\n        }\r\n    }\r\n\r\n    // Get Edit User\r\n    editUser = async (req, res) => {\r\n        const id = req.params.id;\r\n        const sql = `SELECT * FROM thanhvien WHERE id_thanhvien = ${id}`;\r\n        const [rows] = await pool.execute(sql);\r\n        if (rows.length > 0) {\r\n            res.render('pages/index.ejs', {\r\n                user: rows[0],\r\n                page_layout: 'edit-user',\r\n            });\r\n        }\r\n    }\r\n\r\n    // Post Edit User\r\n    updateUser = async (req, res) => {\r\n        const id = req.params.id;\r\n        const { name, sdt, address, sex } = req.body;\r\n        const sql = `UPDATE thanhvien SET sdt = '${sdt}',address = '${address}', name = '${name}', gioi_tinh = ${sex} WHERE thanhvien.id_thanhvien = ${id}`\r\n        await pool.execute(sql);\r\n        res.redirect('/user')\r\n    }\r\n}\r\n\r\n\r\nmodule.exports = new UserController;"
        }
    ]
}